---
title: "Entrenamiento del modelo"
author: "Wilmar Andres Garcia Bedoya"
date: '2022-11-20'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(qpcR)
library(MLmetrics)
```

## Entrenamiento de un modelo predictivo

```{r message=FALSE, warning=FALSE, results = 'hide', echo=F}
#Lectura de la base de datos
bd_depurada <- read.csv("./datos/base_depurada.csv", dec=".", header=T,sep=",")
```

```{r message=FALSE, warning=FALSE, results = 'hide', echo=F}
#Modelo lineal
bd_depurada$CLASE <- as.factor(as.character(bd_depurada$CLASE))
datos_val <- subset(bd_depurada, (ANO == '2019' | ANO == '2020'))

base_train <- subset(bd_depurada, (ANO != '2017' & ANO != '2019' & ANO != '2020'))
#base_final02 <- subset(base_final01, (ANO != '2019'))
#base_final03 <- subset(base_final02, (ANO != '2020'))
datos_lm1 <- base_train %>% group_by(FECHA, FESTIVIDAD, DIA_SEMANA, 
                                   DISENO) %>% count(name = "NRO_ACCID") 
lm1 <- lm(NRO_ACCID ~ FESTIVIDAD+DIA_SEMANA+DISENO, data = datos_lm1)
promedio <- mean(datos_lm1$NRO_ACCID)
TSS <- sum((datos_lm1$NRO_ACCID - promedio)^2)
RSS <- RSS(lm1)
r2 <- 1-RSS/TSS
RSS2 <- anova(lm1)[4, 2]
r2 <- 1-RSS/TSS
```


```{r message=FALSE, warning=FALSE, echo=F}
lm1_data <- bd_depurada %>% group_by(FECHA, FESTIVIDAD, DIA_SEMANA, 
                                   DISENO) %>% count(name = "NRO_ACCID") 
lm1_tr <- lm1_data[,-c(5)]
predicted <- round(predict(lm1, newdata=lm1_tr))
actual <- lm1_data$NRO_ACCID
lm1_mse <- MSE(predicted, actual) # MSE
lm1_mae <- MAE(predicted, actual) # MAE
lm1_r2 <- R2_Score(predicted, actual) # R2
sprintf("MSE: %f, MAE: %f, R2: %f", lm1_mse, lm1_mae, lm1_r2)
```
